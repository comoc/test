<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>YouTube remote</title>
<!--[if IE]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>

<script src="lib/jquery.youtubeplaylist.js"></script>
<script src="lib/jquery.easing.1.3.js"></script>
<script src="lib/jquery.vgrid.0.1.7.min.js"></script>
<script src="lib/jquery.scrollTo-min.js"></script>

<script src="http://swfobject.googlecode.com/svn/trunk/swfobject/swfobject.js"></script>

<script src="/socket.io/socket.io.js"></script>	
<script>  
var KEY_ENTER = 13;
var KEY_LEFT = 37;
var KEY_UP = 38;
var KEY_RIGHT = 39;
var KEY_DOWN = 40;
var player;
var AUTOPLAY = true;
$(function () { 

	var page = 1;
	var pageSize = 18;  

	var cursor;

	$(document).ready(function() {
		//		$("#general").focus();
		createCursor();
	});

	function createCursor() {
    	cursor = $('#cursor');
    	if (!cursor.attr('id')) {
    	  cursor = $('<img>');
    	  cursor.attr('class', 'cursor');
    	  cursor.attr('id', 'cursor');
    	  cursor.attr('src', 'cursor.png');
    	  cursor.css('position', 'fixed');
    	  cursor.css('width', '24px');
    	  cursor.css('height', '24px');
    	  $('#wrapper').append(cursor);
	  }

    	cursor.css('left', '0px');
    	cursor.css('top', '0px');
    	cursor.show();
    	//setTimeout(function() {
    	//  cursor.hide();
	  	//}, 10000);
	}
	function moveCursor(dx, dy) {
		if (cursor) {
			var pos = cursor.position();
			var l = parseInt(pos.left) + dx;
			var t = parseInt(pos.top) + dy;
			var lmin = -cursor.width() / 3;
			var tmin = -cursor.height() / 5;
			var lmax = $(document).width() + lmin;
			var tmax = $(document).height() + tmin;
			if (l < lmin) {
				l = lmin;
			} else if (l > lmax) {
				l = lmax;
			}
			if (t < tmin) {
				t = tmin;
			} else if (t > tmax) {
				t = tmax;
			}
			console.log('l:' + l);
			console.log('t:' + t);
			cursor.css('left', l + 'px');
			cursor.css('top', t + 'px');
		}
	}

	function addItemToGridContent(i, item) {
		if (i == 0)
			$("#grid-content").empty();

		$("#grid-content").append(item);	
		console.log(item);
	}

	function searchVideo(query)  {
		if (!query)
			return;

		var time = 'all_time';  
		var url = 'http://gdata.youtube.com/feeds/api/videos?start-index={page}&max-results={pageSize}&callback=?';  
		var url2 = url.replace('{page}', page).replace('{pageSize}', pageSize);  
		var params = {  
			v: '2',  
			q: query,
			alt: 'json-in-script',  // atom, rss, json, json-in-script(jsonp)  
			format: '5'             // 1-mobile, 5-swf, 6-mobile rtsp  
		}

		$.getJSON(url2, params, function (data) {  
			var feed = data.feed;  
			var entries = feed.entry || [];  
			$.each(data.feed.entry, function (i, item) {  
				var vid = item.media$group.yt$videoid.$t;  
				var title = item.title.$t;  
				var url = item.content.src;  
				var thumbnailUrl = item.media$group.media$thumbnail[0].url;  
				var playerUrl = item.media$group.media$content[0].url;
				console.log("getJson" + i + ", " + thumbnailUrl);
				addItemToGridContent(
					i,
					'<li>'
					+ '<a href="javascript:loadVideo(\''
					+ playerUrl + '\' + true)" title="' + title
					+ '"><img class="my_content" src="' + thumbnailUrl + '" /><br>' + title + '</a>'
					+ '</li>'
				);
			});

			if (entries.length > 0) {
				$("#grid-content").vgrid();

				loadVideo(entries[0].media$group.media$content[0].url, AUTOPLAY);  
				$('#playerContainer').show();  
			}  
		});
	}


	$('#btnSearch').click(function () {  
		var query = $('#txtQuery').val();
		searchVideo(query);
	});

	$('#txtQuery').keydown(function(e) { 
		if (e.keyCode == KEY_ENTER) {
			var query = $('#txtQuery').val();
			if (query)
				$('#btnSearch').trigger('click');  
		}
		console.log(e.keyCode);
	});

	var host = location.host;
	var socket = io.connect('http://' + host);
	socket.on('from_serial', function (data) {
		//				$('#log').html(data.my + '<br>');
		if (data.my.indexOf('DIRL') == 0) {
			sendKeyEvent(true, KEY_RIGHT);
			sendKeyEvent(false, KEY_RIGHT);
			skipVideo(-5);
		} else if (data.my.indexOf('DIRR') == 0) {
			sendKeyEvent(true, KEY_LEFT);
			sendKeyEvent(false, KEY_LEFT);
			skipVideo(5);
		} else if (data.my.indexOf('DIRU') == 0) {
//			sendKeyEvent(true, KEY_UP);
//			sendKeyEvent(false, KEY_UP);
			//playVideo();
			scrollDown();
		} else if (data.my.indexOf('DIRD') == 0) {
			//pauseVideo();
//			sendKeyEvent(true, KEY_DOWN);
//			sendKeyEvent(false, KEY_DOWN);
			scrollUp();
		} else if (data.my.indexOf('TAP_') == 0) {
				playPauseVideo();
		} else if (data.my.indexOf('SEAR,0,') == 0) {
			var query = data.my.substring(7);
			searchVideo(query);
		} else if (data.my.indexOf('TOUC,') == 0) {
			var xyc = data.my.substring(5);
			if (xyc) {
				var xy = xyc.split(',');
				if (xy && xy.length >= 2) {
					console.log(parseInt(xy[0]));
					moveCursor(-parseInt(xy[0]), -parseInt(xy[1]));
				}
			}
		}

		console.log(data.my);
	
	});

	$('input').keydown(function(e){
	    if (e.keyCode == 38) {
	       $('.my_content').prev().focus();   
	    }    
	    if (e.keyCode == 40) {
	       $('.my_content').next().focus();
	    }
	});

	function sendKeyEvent(isPress, keyCode) {
		if (isPress) {
			var e = jQuery.Event("keydown");
			e.which = keyCode;
			$('body').trigger(e);
		}
		else {
			var e = jQuery.Event("keydup");
			e.which = keyCode;
			$('body').trigger(e);
		}
	}

	function scrollUp() {
		scroll('prev');
	}

	function scrollDown() {
		scroll('next');
	}

	// scroll
    function scroll(direction) {

        var scroll, i,
                positions = [],
                here = $(window).scrollTop(),
                collection = $('.post');

        collection.each(function() {
            positions.push(parseInt($(this).offset()['top'],10));
        });

        for(i = 0; i < positions.length; i++) {
            if (direction == 'next' && positions[i] > here) { scroll = collection.get(i); break; }
            if (direction == 'prev' && i > 0 && positions[i] >= here) { scroll = collection.get(i-1); break; }
        }

        if (scroll) {
            $.scrollTo(scroll, {
                duration: 750       
            });
        }

        return false;
    }

    $("#next,#prev").click(function() {        
        return scroll($(this).attr('id'));        
    });

    $(".scrolltoanchor").click(function() {
        $.scrollTo($($(this).attr("href")), {
            duration: 750
        });
        return false;
    });


	function playPauseVideo() {
		player = document.getElementById('player');
		if (player) {
			var s = player.getPlayerState();
			if (s == 1) {
				player.pauseVideo();
			} else if (s == 2 || s == 0) {
				player.playVideo();
			}
		}
	}
	
	function skipVideo(secFromNow) {
		if (player) {
			var dur = player.getDuration();
			var to = secFromNow + player.getCurrentTime();
			if (to < 0)
				to = 0;
			else if (to > dur)
				to = dur;
			player.seekTo(to, true);
		}
	}
	
	function playVideo() {
		if (player) {
			player.playVideo();
		}
	}
	
	function pauseVideo() {
		if (player) {
			player.pauseVideo();
		}
	}
	
	function onytplayerStateChange(newState) {
		console.log("Player's new state: " + newState);
	}
	
	function onYouTubePlayerReady(playerId) {
		if (playerId == 'player') {
			player = document.getElementById('player');
			player.addEventListener("onStateChange", "onytplayerStateChange");
			}
	}
	
	function loadVideo(playerUrl, autoplay) {
		console.log(playerUrl + '&enablejsapi=1&playerapiid=player&rel=1&border=0&fs=1&autoplay=' + (autoplay ? 1 : 0));
		swfobject.embedSWF(
		playerUrl + '&enablejsapi=1&playerapiid=player&rel=1&border=0&fs=1&autohide=1&hd=1&autoplay=' + (autoplay ? 1 : 0),  
		'player', '640', '505', '9.0.0', false, false,
		{ allowfullscreen: 'true', allowScriptAccess: 'always'},  // 290 x 250  
		{ id: "myytplayer" ,wmode: "opaque"}
		); 
	} 
});


</script>

<style type="text/css">
body {
	margin: 0;
	padding: 0;
	line-height:1.4;
	color:#333;
	background-color: #000000;
	font-family:Arial, sans-serif;
	font-size:0.9em;
}

div#search {
	text-align: right; 
}

#grid-content {
	list-style-type: none;
}

#grid-content li {
	width: 160px;
	height: 160px;
	border: 1px solid #000000;
	background-color: #101010;
	color: #FFFFFF;
	margin: 5px;
	padding: 3px;
}

#wrapper {
	z-index: 3999;
}

#nav-dock {
	position: fixed;
	right: 15px;
	top: 35%;
	z-index: 1;
}

#nav-dock a {
	display: block;
	padding: 3px 10px;
	margin: 3px 0;
	background: #666;
	color: #fff;
	-webkit-border-radius: 10px;
	-moz-border-radius: 10px;
	-webkit-box-shadow: 0 1px 2px rgba(0, 0, 0, .3);
	-moz-box-shadow: 0 1px 2px rgba(0, 0, 0, .3);
}
#nav-dock a:hover {
	background: #000;
}
#nav-dock #next {
	margin-bottom: 10px;
}

div#playerContainer {
	text-align: center;
}
div#grid {
	text-align: center;
}
</style>

</head>

<body class="home">
	<div id="wrapper"></div>
<div id="nav-dock"> 
	<a id="prev" href="#">&uarr; Prev</a> 
	<a id="next" href="#">&darr; Next</a>
<!--
	<a href="#comments" class="scrolltoanchor">Comments</a> 
	<a href="#reply" class="scrolltoanchor">Reply</a> 
-->
</div>

	<div class="post">
		<div id="search">
			<input id="txtQuery" type="text" value="" />      
			<button id="btnSearch">Search!</button>    
		</div>
	</div>
	<div class="post">
		<div id="playerContainer">  
		  	<object id="player"></object>
		</div>           
	</div>
	<div class="post">
		<div id="grid">
			<ul id="grid-content"></ul>
		</div>
	</div>
</body>
</html>

